<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Land Capability Verification Editor</title>
    <style>
      html, body, #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/dark-blue/main.css">
    <script src="https://js.arcgis.com/4.11/"></script>
    <script>
        // Declare required widgets
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Expand",
            "esri/widgets/BasemapGallery",
            "esri/widgets/Search",
            "esri/widgets/Editor",
            "esri/layers/TileLayer",
            "esri/widgets/LayerList",
            "esri/widgets/Home",
            "esri/widgets/Legend",
            "esri/WebMap",
            "esri/widgets/Print",
            "esri/widgets/AreaMeasurement2D",
            "esri/widgets/DistanceMeasurement2D",
            "esri/geometry/geometryEngine",
            "esri/widgets/ScaleBar"
            ], 
        // Function to Call widgets     
        function(Map, MapView, FeatureLayer, Expand, BasemapGallery, Search, Editor, TileLayer, LayerList, Home, Legend, WebMap, Print, AreaMeasurement2D, DistanceMeasurement2D, geometryEngine, ScaleBar) {
            
//            var webmap = new WebMap({
//              portalItem: {
//                id: "588261ff6fdd4d2ca2fa3aee96472e36"
//              }
//            });
            
            // Create Map
            var map = new Map({
                basemap: "topo-vector"
                
            });
            
            // Create Map View and add it to the viewDiv container
            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-120.0325,39.0],
                zoom: 10
            });
            
            // Add this action to the popup so it is always available in this view
            var measureThisAction = {
              title: "Measure Area",
              id: "measure-this",
              image: "esri-icon-polygon"
            };

            var template = {
              // autocasts as new PopupTemplate()
              title: "Land Capability: ",
              content: "{LCV_IPES}",
              actions: [measureThisAction]
            };

            // Execute each time the "Measure Length" is clicked
            function measureThis() {
              var geom = view.popup.selectedFeature.geometry;
              var area = geometryEngine.planarArea(geom, "square-feet");
              area = parseFloat(Math.round(area * 100) / 100).toFixed(2);
              view.popup.content =
                view.popup.selectedFeature.attributes.LCV_IPES +
                "<div style='background-color:black;color:white'>" +
                area +
                " sq. ft.</div>";
            }

            // Event handler that fires each time an action is clicked.
            view.popup.on("trigger-action", function(event) {
              // Execute the measureThis() function if the measure-this action is clicked
              if (event.action.id === "measure-this") {
                measureThis();
              }
            });
            
            // Construct LCV Feature Layer
            var lcvLayer = new FeatureLayer({
                url: "https://arcprod.trpa.org/server/rest/services/LandCapability_editable/FeatureServer/0",
                outFields: ["*"],
                popupTemplate: template
            });
            
            // Construct Set Back Feature Layer
            var setbackLayer = new FeatureLayer({
                url: "https://arcprod.trpa.org/server/rest/services/LandCapability_editable/FeatureServer/1",
                outFields: ["*"],
                popupEnabled: false,
            });
            
            // Construct Backshore Layer 
            var backshoreLayer = new FeatureLayer({
                url: "https://arcprod.trpa.org/server/rest/services/LandCapability_editable/FeatureServer/2",
                outFields: ["*"],
                popupEnabled: false,
            });
            
            // Define a popup for Trails
            var popupParcels = {
                "title": "Parcel Information",
                "content": function(){
                   return "APN: {APN}";
                }
              }
            
            // Create Parcel Layer
            var parcels = new FeatureLayer({
                url: "https://maps.trpa.org/server/rest/services/LandCapability_BaseMap/MapServer/0",
                outFields: ["*"],
                popupTemplate: popupParcels
            });
            
            var water = new FeatureLayer({
                url: "https://maps.trpa.org/server/rest/services/LandCapability_BaseMap/MapServer/2",
                outFields: ["*"],
            });
            
            // Create Slope Tile Layer
            var slopeLayer = new TileLayer({
                url: "https://maps.trpa.org/server/rest/services/SlopeClasses_cached/MapServer",
                opacity: 0.75,
            });
            
            // Create Hillsahde Tile Layer
            var hillshadeLayer = new TileLayer({
                url: "https://maps.trpa.org/server/rest/services/Tahoe_Hillshade_cached/MapServer",
                opacity: 0.75,
            });

            // Add the layer
            map.add(lcvLayer,0)
            
            // Add the layer
            map.add(setbackLayer,1)
            
            // Add the layer
            map.add(backshoreLayer,2)
            
            // Add the layer
            map.add(slopeLayer);
            
            // Add the layer
            map.add(hillshadeLayer);

            // Add the layer
            map.add(parcels,0);
            
            // Add the layer
            map.add(water,1);
            
            // Create Editor widget
            var editor = new Editor({
                container: document.createElement("div"),
                view: view
            });
            
            var editorExpand = new Expand({
                expandIconClass: "esri-icon-sketch-rectangle",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Editor",
                view: view,
                content: editor.domNode
            });
            
            // Add editor widget to view
            view.ui.add(editorExpand, "top-right");
            
            // Creaete Table of Contents
            var layerList = new LayerList({
                container: document.createElement("div"),
                view: view,  
//                listItemCreatedFunction: function (event) {
//                    const item = event.item;
//                    item.panel = {
//                      content: "legend",
//                      open: true
//                    };
//                },
//                showLegend: true,
                layers: [
                    {  
                    layer: lcvLayer,
                    title: "Verified Land Capability",  
                    },  
                    {  
                    layer: setbackLayer,  
                    title: "Setback",  
                    },  
                    {  
                    layer: backshoreLayer,  
                    title:"Backshore Boundary"  
                    },  
                    {  
                    layer: parcels,  
                    title:"Parcels"  
                    },  
                    {  
                    layer: water,  
                    title:"Water"  
                    },
                    {  
                    layer: slopeLayer,  
                    title:"Slope"  
                    },
                    {  
                    layer: hillshadeLayer,  
                    title:"Hillshade"  
                    }] 
            });
            
            // Create collapasable button for Table of Contents
            var layerListExpand = new Expand({
                expandIconClass: "esri-icon-layer-list",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Layer List",
                view: view,
                content: layerList.domNode
                });
            
            view.ui.add(layerListExpand, "top-right");
            
            // To add the AreaMeasurement2D widget to your map
            var measurementWidget = new AreaMeasurement2D({
                container: document.createElement("div"),
                view: view,
                unit: "square-feet"
            });
            
            var measureExpand = new Expand({
                expandIconClass: "esri-icon-polygon",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Measure Area",
                view: view,
                content: measurementWidget.domNode
            });
            
            // Add Measure Button
            view.ui.add(measureExpand, "top-right");
            
            // To add the DistanceMeasurement2D widget to the map
            var distanceWidget = new DistanceMeasurement2D({
                container: document.createElement("div"),
                view: view,
                unit: "feet"
            });
            
            // Create Meassure Distance Button
            var distanceExpand = new Expand({
                expandIconClass: "esri-icon-polyline",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Measure Distance",
                view: view,
                content: distanceWidget.domNode
            });
            
            // Add Button for meassureing Distance
            view.ui.add(distanceExpand, "top-right");
             
            // function to create print service
            view.when(function() {
                var print = new Print({
                    container: document.createElement("div"),
                    view: view,
                    // specify your own print service
                   printServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"

            });
            
            // Create Print Button
            var printExpand = new Expand({
                expandIconClass: "esri-icon-printer",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Print",
                view: view,
                content: print.domNode
                });

            // Add print widget to the top right corner of the view
            view.ui.add(printExpand, "top-right");
            });
            
            // Create Search Widget
            var searchWidget = new Search({
              view: view,
              allPlaceholder: "APN",
              sources: [
                {
                  layer: parcels,
                  searchFields: ["APN"],
                  displayField: "APN",
                  exactMatch: false,
                  outFields: ["APN"],
                  name: "Parcel APN",
                  placeholder: "123-123-123"
                }
              ]
            });
            
            // Add the search widget to the top left corner of the view
            view.ui.add(searchWidget, {
                position: "top-left"
            });
            
            // move zoom buttons to top left
            view.ui.move("zoom", "top-left");
            
            // Createa Home Button
            var homeWidget = new Home({
              view: view
            });

            // adds the home widget to the top left corner of the MapView
            view.ui.add(homeWidget, "top-left");
            
            // Create Legend Widget
            var legend = new Legend({
                container: document.createElement("div"),
                view: view,
//                style: "card",
                layerInfos: [
                    {  
                    layer: lcvLayer,
                    title: "Verified Land Capability",  
                    },  
                    {  
                    layer: setbackLayer,  
                    title: "Setback",  
                    },  
                    {  
                    layer: backshoreLayer,  
                    title: "Backshore Boundary"  
                    },  
                    {  
                    layer: parcels,  
                    title: "Parcels"  
                    },  
                    {  
                    layer: water,  
                    title: "Water"  
                    },
                    {  
                    layer: slopeLayer,  
                    title: "Slope"  
                    }
                ]
            });
            
            // Create Legend button
            var legendExpand = new Expand({
                expandIconClass: "esri-icon-layers",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
                expandTooltip: "Expand Legend",
                view: view,
                content: legend.domNode
                });
        
            // Add Legend to the bottom right corner of the view
            view.ui.add(legendExpand, "bottom-left");    
            
            // Create Basemap Gallery Widget
            var basemapGallery = new BasemapGallery({
                container: document.createElement("div"),
                view: view,
                source: {
                  portal: {
                    url: "https://www.arcgis.com",
                    useVectorBasemaps: true  // Load vector tile basemaps
                  }
                }
              });
            
            // Create an Expand instance and set the content
            // property to the DOM node of the basemap gallery widget
            var bgExpand = new Expand({
                expandIconClass: "esri-icon-basemap",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font
                expandTooltip: "Expand Basemap Gallery",
                view: view,
                content: basemapGallery.domNode
            });

            // Add the basemap gallery button
            view.ui.add(bgExpand, "bottom-left");   
            
            // Create Scale Bar Widget
            var scaleBar = new ScaleBar({
              view: view
            });
            
            // Add widget to the bottom left corner of the view
            view.ui.add(scaleBar, {
              position: "bottom-right"
            });
      });
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
</html>